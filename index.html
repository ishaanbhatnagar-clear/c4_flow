<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peppol 4-Corner Model - Sequence Diagram</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #ffffff;
            --bg-secondary: #f7f7f8;
            --bg-tertiary: #ececf1;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-muted: #999999;
            --border-color: #e5e5e5;
            --border-dark: #d0d0d0;
            --accent: #1a1a1a;
            --accent-light: #f0f0f0;
            --success: #059669;
            --warning: #d97706;
            --error: #dc2626;
            --info: #2563eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 14px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 32px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        /* Step Controls */
        .step-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding: 14px 24px;
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        .step-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .step-btn.primary {
            background: var(--text-primary);
            color: white;
        }

        .step-btn.primary:hover:not(:disabled) {
            background: #333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .step-btn.secondary {
            background: white;
            color: var(--text-primary);
            border: 2px solid var(--border-dark);
        }

        .step-btn.secondary:hover:not(:disabled) {
            background: var(--bg-tertiary);
        }

        .step-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .step-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .step-indicator strong {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 14px;
        }

        .step-progress {
            display: flex;
            gap: 6px;
        }

        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .step-dot:hover {
            border-color: var(--text-secondary);
        }

        .step-dot.active {
            background: var(--text-primary);
            transform: scale(1.2);
        }

        .step-dot.completed {
            background: var(--success);
        }

        .step-title {
            min-width: 220px;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
            text-align: center;
        }

        /* Diagram Container */
        .diagram-container {
            background: var(--bg-main);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 32px;
            overflow-x: auto;
        }

        .diagram-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* SVG Styles */
        .svg-container {
            display: flex;
            justify-content: center;
        }

        svg {
            font-family: 'Inter', sans-serif;
        }

        /* Animated elements */
        .step-element {
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .step-element.visible {
            opacity: 1;
        }

        .step-element.animate-in {
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Legend */
        .legend-bar {
            display: flex;
            justify-content: center;
            gap: 24px;
            padding: 12px 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .legend-line {
            width: 24px;
            height: 2px;
            background: var(--text-primary);
        }

        .legend-line.dashed {
            background: repeating-linear-gradient(
                90deg,
                var(--text-primary) 0px,
                var(--text-primary) 4px,
                transparent 4px,
                transparent 8px
            );
        }

        .legend-arrow {
            width: 0;
            height: 0;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
            border-left: 6px solid var(--text-primary);
        }

        /* Info Cards */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 32px;
        }

        @media (max-width: 1000px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
        }

        .info-card {
            background: var(--bg-main);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .info-card:hover {
            border-color: var(--border-dark);
        }

        .info-card-header {
            padding: 14px 18px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            background: var(--bg-secondary);
        }

        .info-card-header h3 {
            font-size: 14px;
            font-weight: 700;
            flex: 1;
            color: var(--text-primary);
        }

        .info-card-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background: var(--bg-tertiary);
        }

        .expand-icon {
            width: 20px;
            height: 20px;
            color: var(--text-muted);
            transition: transform 0.2s ease;
        }

        .info-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .info-card-body {
            padding: 0 18px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .info-card.expanded .info-card-body {
            padding: 18px;
            max-height: 2000px;
            overflow-x: auto;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .data-table th,
        .data-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            font-weight: 700;
            color: var(--text-secondary);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg-tertiary);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover td {
            background: var(--bg-secondary);
        }

        .data-table code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .status-dot.green { background: var(--success); }
        .status-dot.orange { background: var(--warning); }
        .status-dot.red { background: var(--error); }
        .status-dot.blue { background: var(--info); }
        .status-dot.purple { background: #7c3aed; }

        .detail-badge {
            display: inline-flex;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        .detail-badge.sync { background: #e0f2fe; color: #0369a1; }
        .detail-badge.async { background: #fef3c7; color: #92400e; }
        .detail-badge.optional { background: var(--bg-tertiary); color: var(--text-secondary); }

        /* Footer */
        .footer {
            margin-top: 32px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            font-size: 11px;
            color: var(--text-muted);
        }

        .footer a {
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 600;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background: var(--text-primary);
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 280px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 700;
            margin-bottom: 2px;
        }

        .tooltip-content {
            font-size: 11px;
            color: #ccc;
        }

        /* Detail Panel */
        .detail-panel {
            position: fixed;
            top: 0;
            right: -360px;
            width: 340px;
            height: 100vh;
            background: var(--bg-main);
            border-left: 1px solid var(--border-color);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .detail-panel.open {
            right: 0;
        }

        .detail-panel-header {
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-panel-header h3 {
            font-size: 14px;
            font-weight: 700;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-tertiary);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .close-btn:hover {
            background: var(--border-color);
        }

        .detail-panel-content {
            padding: 20px;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section h4 {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-item .label {
            color: var(--text-secondary);
        }

        .detail-item .value {
            font-weight: 600;
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 16px 12px;
            }

            .header h1 {
                font-size: 22px;
            }

            .step-controls {
                flex-direction: column;
                gap: 10px;
            }

            .step-title {
                min-width: auto;
            }

            .detail-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>Peppol 4-Corner Model</h1>
        </header>

        <!-- Step Controls -->
        <div class="step-controls">
            <button class="step-btn secondary" id="prevBtn" onclick="prevStep()" disabled>
                <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/>
                </svg>
                Previous
            </button>

            <div class="step-indicator">
                <span>Step</span>
                <strong id="currentStep">1</strong>
                <span>of</span>
                <strong id="totalSteps">8</strong>
            </div>

            <div class="step-progress" id="stepProgress"></div>

            <div class="step-title" id="stepTitle">C1 submits invoice to C2</div>

            <button class="step-btn primary" id="nextBtn" onclick="nextStep()">
                Next Step
                <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                </svg>
            </button>

            <button class="step-btn secondary" id="resetBtn" onclick="resetSteps()">
                <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"/>
                </svg>
                Reset
            </button>
        </div>

        <!-- Diagram -->
        <div class="diagram-container">
            <div class="diagram-title">Sequence Diagram - Click "Next Step" to progress</div>
            <div class="svg-container">
                <svg width="950" height="650" viewBox="0 0 950 800" id="sequence-diagram" style="max-width:100%;height:auto;">
                    <!-- Participant boxes at top -->
                    <g class="participant-group" data-participant="c1" onclick="showDetail('c1')" style="cursor:pointer">
                        <rect x="60" y="30" width="140" height="70" rx="8" fill="#1a1a1a"/>
                        <text x="130" y="60" text-anchor="middle" fill="white" font-size="22" font-weight="700">C1</text>
                        <text x="130" y="82" text-anchor="middle" fill="#cccccc" font-size="14" font-weight="500">Clear SaaS</text>
                    </g>

                    <g class="participant-group" data-participant="c2" onclick="showDetail('c2')" style="cursor:pointer">
                        <rect x="280" y="30" width="140" height="70" rx="8" fill="#1a1a1a"/>
                        <text x="350" y="60" text-anchor="middle" fill="white" font-size="22" font-weight="700">C2</text>
                        <text x="350" y="82" text-anchor="middle" fill="#cccccc" font-size="14" font-weight="500">Clear AP</text>
                    </g>

                    <g class="participant-group" data-participant="c3" onclick="showDetail('c3')" style="cursor:pointer">
                        <rect x="500" y="30" width="140" height="70" rx="8" fill="#1a1a1a"/>
                        <text x="570" y="60" text-anchor="middle" fill="white" font-size="22" font-weight="700">C3</text>
                        <text x="570" y="82" text-anchor="middle" fill="#cccccc" font-size="14" font-weight="500">Buyer AP</text>
                    </g>

                    <g class="participant-group" data-participant="c4" onclick="showDetail('c4')" style="cursor:pointer">
                        <rect x="720" y="30" width="140" height="70" rx="8" fill="#1a1a1a"/>
                        <text x="790" y="60" text-anchor="middle" fill="white" font-size="22" font-weight="700">C4</text>
                        <text x="790" y="82" text-anchor="middle" fill="#cccccc" font-size="14" font-weight="500">Buyer ERP</text>
                    </g>

                    <!-- Lifelines -->
                    <line x1="130" y1="100" x2="130" y2="760" stroke="#d0d0d0" stroke-width="2" stroke-dasharray="10,8"/>
                    <line x1="350" y1="100" x2="350" y2="760" stroke="#d0d0d0" stroke-width="2" stroke-dasharray="10,8"/>
                    <line x1="570" y1="100" x2="570" y2="760" stroke="#d0d0d0" stroke-width="2" stroke-dasharray="10,8"/>
                    <line x1="790" y1="100" x2="790" y2="760" stroke="#d0d0d0" stroke-width="2" stroke-dasharray="10,8"/>

                    <!-- STEP 1: Submit Invoice C1 to C2 -->
                    <g class="step-element" data-step="1">
                        <rect x="124" y="120" width="12" height="40" rx="4" fill="#e5e5e5" stroke="#999" stroke-width="1"/>
                        <g class="message-group" onclick="showDetail('msg1')" style="cursor:pointer">
                            <line x1="136" y1="140" x2="338" y2="140" stroke="#1a1a1a" stroke-width="3"/>
                            <polygon points="338,140 326,134 326,146" fill="#1a1a1a"/>
                            <rect x="170" y="122" width="140" height="32" rx="6" fill="white" stroke="#1a1a1a" stroke-width="2"/>
                            <text x="240" y="144" text-anchor="middle" font-size="15" font-weight="700" fill="#1a1a1a">1: submitInvoice()</text>
                        </g>
                    </g>

                    <!-- STEP 2: SMP Lookup -->
                    <g class="step-element" data-step="2">
                        <rect x="420" y="165" width="70" height="36" rx="6" fill="#f7f7f8" stroke="#999" stroke-width="2"/>
                        <text x="455" y="188" text-anchor="middle" font-size="14" font-weight="700" fill="#1a1a1a">SMP</text>

                        <rect x="344" y="165" width="12" height="70" rx="4" fill="#e5e5e5" stroke="#999" stroke-width="1"/>
                        <g class="message-group" onclick="showDetail('msg2')" style="cursor:pointer">
                            <line x1="356" y1="185" x2="418" y2="185" stroke="#1a1a1a" stroke-width="3"/>
                            <polygon points="418,185 408,180 408,190" fill="#1a1a1a"/>
                            <text x="387" y="175" text-anchor="middle" font-size="14" font-weight="700" fill="#1a1a1a">2: lookup()</text>
                        </g>
                        <g class="message-group">
                            <line x1="418" y1="210" x2="356" y2="210" stroke="#666" stroke-width="2" stroke-dasharray="8,5"/>
                            <polygon points="356,210 366,205 366,215" fill="#666"/>
                            <text x="387" y="228" text-anchor="middle" font-size="12" fill="#666" font-weight="500">endpoint + cert</text>
                        </g>
                    </g>

                    <!-- STEP 3: C2 Processing + AS4 Send -->
                    <g class="step-element" data-step="3">
                        <rect x="344" y="250" width="12" height="110" rx="4" fill="#e5e5e5" stroke="#999" stroke-width="1"/>

                        <!-- Processing note -->
                        <rect x="370" y="255" width="130" height="60" rx="8" fill="#f7f7f8" stroke="#d0d0d0" stroke-width="1"/>
                        <text x="380" y="278" font-size="13" font-weight="700" fill="#1a1a1a">C2 Processing:</text>
                        <text x="380" y="296" font-size="12" fill="#666">Wrap in SBD</text>
                        <text x="380" y="310" font-size="12" fill="#666">Sign message</text>

                        <g class="message-group" onclick="showDetail('msg3')" style="cursor:pointer">
                            <line x1="356" y1="340" x2="558" y2="340" stroke="#1a1a1a" stroke-width="3"/>
                            <polygon points="558,340 546,334 546,346" fill="#1a1a1a"/>
                            <rect x="380" y="322" width="160" height="32" rx="6" fill="#1a1a1a"/>
                            <text x="460" y="344" text-anchor="middle" font-size="15" font-weight="700" fill="white">3: AS4 (Invoice)</text>
                        </g>
                    </g>

                    <!-- STEP 4: AS4 Response -->
                    <g class="step-element" data-step="4">
                        <rect x="564" y="340" width="12" height="160" rx="4" fill="#e5e5e5" stroke="#999" stroke-width="1"/>

                        <!-- Alt frame -->
                        <rect x="325" y="365" width="280" height="125" rx="8" fill="none" stroke="#d0d0d0" stroke-width="2"/>
                        <rect x="325" y="365" width="40" height="24" rx="4" fill="#f7f7f8" stroke="#d0d0d0"/>
                        <text x="345" y="382" text-anchor="middle" font-size="12" font-weight="700" fill="#666">alt</text>

                        <!-- Success path -->
                        <text x="340" y="405" font-size="13" fill="#059669" font-weight="600">[success]</text>
                        <line x1="564" y1="420" x2="368" y2="420" stroke="#059669" stroke-width="2" stroke-dasharray="8,5"/>
                        <polygon points="368,420 378,415 378,425" fill="#059669"/>
                        <rect x="420" y="406" width="100" height="26" rx="6" fill="#ecfdf5" stroke="#059669" stroke-width="2"/>
                        <text x="470" y="424" text-anchor="middle" font-size="14" font-weight="700" fill="#059669">4a: AS4 (+)</text>

                        <!-- Divider -->
                        <line x1="325" y1="448" x2="605" y2="448" stroke="#d0d0d0" stroke-dasharray="6,4"/>

                        <!-- Failure path -->
                        <text x="340" y="470" font-size="13" fill="#dc2626" font-weight="600">[failure]</text>
                        <line x1="564" y1="480" x2="368" y2="480" stroke="#dc2626" stroke-width="2" stroke-dasharray="8,5"/>
                        <polygon points="368,480 378,475 378,485" fill="#dc2626"/>
                        <rect x="420" y="466" width="100" height="26" rx="6" fill="#fef2f2" stroke="#dc2626" stroke-width="2"/>
                        <text x="470" y="484" text-anchor="middle" font-size="14" font-weight="700" fill="#dc2626">4b: AS4 (-)</text>

                        <!-- Note about AS4 -->
                        <rect x="620" y="370" width="160" height="95" rx="8" fill="#fffbeb" stroke="#d97706" stroke-width="1"/>
                        <text x="630" y="390" font-size="11" fill="#92400e" font-weight="700">AS4 sent only ONCE</text>
                        <text x="630" y="408" font-size="10" fill="#92400e">Varies by AP:</text>
                        <text x="630" y="424" font-size="10" fill="#92400e">• Minimal: receipt only</text>
                        <text x="630" y="440" font-size="10" fill="#92400e">• Strict: + validation</text>
                    </g>

                    <!-- STEP 5: MLS Response -->
                    <g class="step-element" data-step="5">
                        <!-- Opt frame for MLS - spans C2 to C4 to show dependency -->
                        <rect x="325" y="500" width="480" height="80" rx="8" fill="none" stroke="#d0d0d0" stroke-width="2"/>
                        <rect x="325" y="500" width="40" height="24" rx="4" fill="#f7f7f8" stroke="#d0d0d0"/>
                        <text x="345" y="517" text-anchor="middle" font-size="12" font-weight="700" fill="#666">opt</text>
                        <text x="380" y="517" font-size="12" fill="#666" font-style="italic">[C3 supports MLS]</text>

                        <!-- C3 to C4 delivery attempt (dotted to show it informs MLS) -->
                        <line x1="576" y1="535" x2="778" y2="535" stroke="#999" stroke-width="1" stroke-dasharray="4,3"/>
                        <polygon points="778,535 770,532 770,538" fill="#999"/>
                        <text x="677" y="528" text-anchor="middle" font-size="9" fill="#666">delivery attempt</text>

                        <!-- C4 response back to C3 -->
                        <line x1="778" y1="550" x2="576" y2="550" stroke="#999" stroke-width="1" stroke-dasharray="4,3"/>
                        <polygon points="576,550 584,547 584,553" fill="#999"/>
                        <text x="677" y="563" text-anchor="middle" font-size="9" fill="#666">DL/DF status</text>

                        <!-- MLS from C3 to C2 -->
                        <line x1="564" y1="570" x2="368" y2="570" stroke="#7c3aed" stroke-width="2" stroke-dasharray="8,5"/>
                        <polygon points="368,570 378,565 378,575" fill="#7c3aed"/>
                        <rect x="395" y="556" width="150" height="26" rx="6" fill="#f5f3ff" stroke="#7c3aed" stroke-width="2"/>
                        <text x="470" y="574" text-anchor="middle" font-size="14" font-weight="700" fill="#6d28d9">5: MLS (AP/AB/RE)</text>

                        <!-- Note explaining MLS depends on C4 -->
                        <rect x="810" y="500" width="130" height="80" rx="8" fill="#f5f3ff" stroke="#7c3aed" stroke-width="1"/>
                        <text x="820" y="518" font-size="10" fill="#6d28d9" font-weight="700">MLS sent 1+ times</text>
                        <text x="820" y="534" font-size="9" fill="#7c3aed">DL/DF based on</text>
                        <text x="820" y="546" font-size="9" fill="#7c3aed">C3→C4 outcome</text>
                        <text x="820" y="562" font-size="9" fill="#7c3aed">SV/BV = validation</text>
                        <text x="820" y="574" font-size="9" fill="#7c3aed">NR = no route</text>
                    </g>

                    <!-- STEP 6: Deliver to C4 (main delivery) -->
                    <g class="step-element" data-step="6">
                        <rect x="564" y="500" width="12" height="110" rx="4" fill="#e5e5e5" stroke="#999" stroke-width="1"/>
                        <g class="message-group" onclick="showDetail('msg6')" style="cursor:pointer">
                            <line x1="576" y1="600" x2="778" y2="600" stroke="#1a1a1a" stroke-width="3"/>
                            <polygon points="778,600 766,594 766,606" fill="#1a1a1a"/>
                            <rect x="610" y="584" width="140" height="28" rx="6" fill="white" stroke="#1a1a1a" stroke-width="2"/>
                            <text x="680" y="603" text-anchor="middle" font-size="13" font-weight="700" fill="#1a1a1a">6: deliverInvoice()</text>
                        </g>
                    </g>

                    <!-- STEP 7: C4 Processing -->
                    <g class="step-element" data-step="7">
                        <rect x="784" y="625" width="12" height="60" rx="4" fill="#e5e5e5" stroke="#999" stroke-width="1"/>
                        <rect x="805" y="628" width="120" height="54" rx="8" fill="#f7f7f8" stroke="#d0d0d0" stroke-width="1"/>
                        <text x="815" y="648" font-size="11" font-weight="700" fill="#1a1a1a">C4 Processing:</text>
                        <text x="815" y="664" font-size="10" fill="#666">Business review</text>
                        <text x="815" y="678" font-size="10" fill="#666">Accept/Reject</text>
                    </g>

                    <!-- STEP 8: IMR Response -->
                    <g class="step-element" data-step="8">
                        <!-- Opt frame for IMR -->
                        <rect x="110" y="700" width="705" height="50" rx="8" fill="none" stroke="#d0d0d0" stroke-width="2"/>
                        <rect x="110" y="700" width="40" height="22" rx="4" fill="#f7f7f8" stroke="#d0d0d0"/>
                        <text x="130" y="715" text-anchor="middle" font-size="11" font-weight="700" fill="#666">opt</text>
                        <text x="165" y="715" font-size="10" fill="#666" font-style="italic">[Buyer sends response]</text>

                        <line x1="784" y1="730" x2="142" y2="730" stroke="#d97706" stroke-width="2" stroke-dasharray="8,5"/>
                        <polygon points="142,730 152,725 152,735" fill="#d97706"/>
                        <rect x="400" y="717" width="150" height="24" rx="6" fill="#fffbeb" stroke="#d97706" stroke-width="2"/>
                        <text x="475" y="734" text-anchor="middle" font-size="12" font-weight="700" fill="#b45309">7: IMR (AP/AB/RE)</text>
                    </g>

                    <!-- Bottom participant boxes -->
                    <rect x="60" y="760" width="140" height="24" rx="6" fill="#1a1a1a"/>
                    <text x="130" y="777" text-anchor="middle" fill="white" font-size="12" font-weight="600">C1</text>

                    <rect x="280" y="760" width="140" height="24" rx="6" fill="#1a1a1a"/>
                    <text x="350" y="777" text-anchor="middle" fill="white" font-size="12" font-weight="600">C2</text>

                    <rect x="500" y="760" width="140" height="24" rx="6" fill="#1a1a1a"/>
                    <text x="570" y="777" text-anchor="middle" fill="white" font-size="12" font-weight="600">C3</text>

                    <rect x="720" y="760" width="140" height="24" rx="6" fill="#1a1a1a"/>
                    <text x="790" y="777" text-anchor="middle" fill="white" font-size="12" font-weight="600">C4</text>
                </svg>
            </div>

            <!-- Legend -->
            <div class="legend-bar">
                <div class="legend-item">
                    <div class="legend-line"></div>
                    <div class="legend-arrow"></div>
                    <span>Sync</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line dashed"></div>
                    <div class="legend-arrow"></div>
                    <span>Async/Return</span>
                </div>
                <div class="legend-item">
                    <div style="width:16px;height:10px;background:#e5e5e5;border:1px solid #999;border-radius:2px;"></div>
                    <span>Activation</span>
                </div>
                <div class="legend-item">
                    <div style="padding:2px 5px;border:1px solid #d0d0d0;border-radius:3px;font-size:9px;font-weight:600;">alt</div>
                    <span>Alternative</span>
                </div>
                <div class="legend-item">
                    <div style="padding:2px 5px;border:1px solid #d0d0d0;border-radius:3px;font-size:9px;font-weight:600;">opt</div>
                    <span>Optional</span>
                </div>
            </div>
        </div>

        <!-- Info Cards -->
        <div class="info-grid">
            <!-- Message Details Card -->
            <div class="info-card expanded" id="card-messages">
                <div class="info-card-header" onclick="toggleCard('card-messages')">
                    <div class="info-card-icon">&#128232;</div>
                    <h3>Message Flow Details</h3>
                    <svg class="expand-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                    </svg>
                </div>
                <div class="info-card-body">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Message</th>
                                <th>Route</th>
                                <th>Protocol</th>
                                <th>Timing</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>1</strong></td>
                                <td><code>submitInvoice()</code></td>
                                <td>C1 &rarr; C2</td>
                                <td>REST</td>
                                <td><span class="detail-badge sync">Sync</span></td>
                            </tr>
                            <tr>
                                <td><strong>2</strong></td>
                                <td><code>lookup()</code></td>
                                <td>C2 &rarr; SMP</td>
                                <td>REST</td>
                                <td><span class="detail-badge sync">Sync</span></td>
                            </tr>
                            <tr>
                                <td><strong>3</strong></td>
                                <td><code>AS4 Message</code></td>
                                <td>C2 &rarr; C3</td>
                                <td>AS4</td>
                                <td><span class="detail-badge sync">Sync</span></td>
                            </tr>
                            <tr>
                                <td><strong>4</strong></td>
                                <td><code>AS4 Response</code></td>
                                <td>C3 &rarr; C2</td>
                                <td>AS4</td>
                                <td><span class="detail-badge sync">Immed</span></td>
                            </tr>
                            <tr>
                                <td><strong>5</strong></td>
                                <td><code>MLS</code> <span class="detail-badge optional">1+ times</span></td>
                                <td>C3 &rarr; C2</td>
                                <td>AS4</td>
                                <td><span class="detail-badge async">Async</span></td>
                            </tr>
                            <tr>
                                <td><strong>6</strong></td>
                                <td><code>deliverInvoice()</code></td>
                                <td>C3 &rarr; C4</td>
                                <td>Custom</td>
                                <td><span class="detail-badge async">Async</span></td>
                            </tr>
                            <tr>
                                <td><strong>7</strong></td>
                                <td><code>IMR</code> <span class="detail-badge optional">Optional</span></td>
                                <td>C4 &rarr; C1</td>
                                <td>BIS</td>
                                <td><span class="detail-badge async">Async</span></td>
                            </tr>
                        </tbody>
                    </table>
                    <p style="font-size:13px;color:var(--text-muted);margin-top:16px;">
                        <strong>Note:</strong> AS4 is sent once. MLS can be sent multiple times for progressive status updates.
                    </p>
                </div>
            </div>

            <!-- AS4 Response Card -->
            <div class="info-card expanded" id="card-mdn">
                <div class="info-card-header" onclick="toggleCard('card-mdn')">
                    <div class="info-card-icon">&#9888;&#65039;</div>
                    <h3>AS4 Response Interpretation</h3>
                    <svg class="expand-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                    </svg>
                </div>
                <div class="info-card-body">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>AP Type</th>
                                <th>Validates Before AS4</th>
                                <th>Positive AS4 Means</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="status-dot orange"></span><strong>Minimal</strong></td>
                                <td>None</td>
                                <td>Bytes received</td>
                            </tr>
                            <tr>
                                <td><span class="status-dot orange"></span><strong>Moderate</strong></td>
                                <td>SBD envelope</td>
                                <td>Received + envelope valid</td>
                            </tr>
                            <tr>
                                <td><span class="status-dot green"></span><strong>Strict</strong></td>
                                <td>Full Schema + Schematron</td>
                                <td>Received + validated</td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="background:#fffbeb;padding:16px;border-radius:10px;margin-top:20px;border:1px solid #fcd34d;">
                        <p style="font-size:14px;color:#92400e;">
                            <strong>Important:</strong> You cannot assume validation passed from a positive AS4 response unless you know C3's implementation.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Types of MLS Card -->
            <div class="info-card expanded" id="card-mls">
                <div class="info-card-header" onclick="toggleCard('card-mls')">
                    <div class="info-card-icon">&#128221;</div>
                    <h3>Types of MLS (Message Level Status)</h3>
                    <svg class="expand-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                    </svg>
                </div>
                <div class="info-card-body">
                    <h4 style="font-size:13px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:14px;">Response Status Codes</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Status</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="status-dot green"></span><strong>AP</strong></td>
                                <td>Accepted</td>
                                <td>Message accepted and delivered to C4</td>
                            </tr>
                            <tr>
                                <td><span class="status-dot orange"></span><strong>AB</strong></td>
                                <td>Acknowledged</td>
                                <td>Message received, processing in progress</td>
                            </tr>
                            <tr>
                                <td><span class="status-dot red"></span><strong>RE</strong></td>
                                <td>Rejected</td>
                                <td>Message rejected (see reason code)</td>
                            </tr>
                        </tbody>
                    </table>

                    <h4 style="font-size:13px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin:28px 0 14px;">Status Reason Codes</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Meaning</th>
                                <th>Context</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="status-dot blue"></span><strong>SV</strong></td>
                                <td>Schema Validation</td>
                                <td>XSD validation failure</td>
                            </tr>
                            <tr>
                                <td><span class="status-dot purple"></span><strong>BV</strong></td>
                                <td>Business Validation</td>
                                <td>Schematron/business rule failure</td>
                            </tr>
                            <tr>
                                <td><span class="status-dot green"></span><strong>DL</strong></td>
                                <td>Delivered</td>
                                <td>Successfully delivered to C4</td>
                            </tr>
                            <tr>
                                <td><span class="status-dot orange"></span><strong>DF</strong></td>
                                <td>Delivery Failed</td>
                                <td>Could not reach C4</td>
                            </tr>
                            <tr>
                                <td><span class="status-dot red"></span><strong>NR</strong></td>
                                <td>Not Routable</td>
                                <td>No valid endpoint for recipient</td>
                            </tr>
                        </tbody>
                    </table>

                    <div style="background:#f5f3ff;padding:16px;border-radius:10px;margin-top:20px;border:1px solid #c4b5fd;">
                        <p style="font-size:14px;color:#6d28d9;">
                            <strong>Example MLS:</strong> Status=<code style="background:#ede9fe;padding:2px 6px;border-radius:4px;">RE</code> + Reason=<code style="background:#ede9fe;padding:2px 6px;border-radius:4px;">BV</code> = Rejected due to Schematron validation failure
                        </p>
                    </div>

                    <h4 style="font-size:13px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin:28px 0 14px;">MLS Can Be Sent Multiple Times</h4>
                    <p style="font-size:14px;color:var(--text-secondary);margin-bottom:14px;">
                        C3 can send <strong>progressive status updates</strong> for the same invoice:
                    </p>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Sequence</th>
                                <th>Status</th>
                                <th>Reason</th>
                                <th>Meaning</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1st MLS</td>
                                <td><strong>AB</strong></td>
                                <td>-</td>
                                <td>Acknowledged, processing...</td>
                            </tr>
                            <tr>
                                <td>2nd MLS</td>
                                <td><strong>AP</strong></td>
                                <td>DL</td>
                                <td>Accepted &amp; Delivered to C4</td>
                            </tr>
                        </tbody>
                    </table>
                    <p style="font-size:13px;color:var(--text-muted);margin-top:12px;font-style:italic;">
                        Note: AS4 is sent only once. MLS provides lifecycle tracking for the invoice.
                    </p>
                </div>
            </div>

            <!-- IMR Status Codes Card -->
            <div class="info-card" id="card-codes">
                <div class="info-card-header" onclick="toggleCard('card-codes')">
                    <div class="info-card-icon">&#10003;</div>
                    <h3>IMR Status Codes</h3>
                    <svg class="expand-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                    </svg>
                </div>
                <div class="info-card-body">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Meaning</th>
                                <th>Business Impact</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="status-dot green"></span><strong>AP</strong></td>
                                <td>Approved</td>
                                <td>Invoice accepted, payment will proceed</td>
                            </tr>
                            <tr>
                                <td><span class="status-dot orange"></span><strong>AB</strong></td>
                                <td>Acknowledged</td>
                                <td>Under review, decision pending</td>
                            </tr>
                            <tr>
                                <td><span class="status-dot red"></span><strong>RE</strong></td>
                                <td>Rejected</td>
                                <td>Invoice disputed, requires resolution</td>
                            </tr>
                        </tbody>
                    </table>
                    <p style="margin-top:20px;font-size:14px;color:var(--text-secondary);">
                        <strong>Note:</strong> IMR is a business-level response from C4 to C1. It's optional and may take days to arrive.
                    </p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>
                <strong>Sources:</strong>
                <a href="https://docs.peppol.eu/edelivery/specs/mls/v1.0.0/mls/spec/" target="_blank">Peppol MLS Spec</a> &bull;
                <a href="https://docs.peppol.eu/poacc/billing/3.0/" target="_blank">Peppol BIS Billing 3.0</a>
            </p>
            <p style="margin-top:10px;">Belgium operates under Hermes (Belgian Peppol Authority)</p>
        </footer>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip">
        <div class="tooltip-title"></div>
        <div class="tooltip-content"></div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="closeDetail()"></div>

    <!-- Detail Panel -->
    <div class="detail-panel" id="detail-panel">
        <div class="detail-panel-header">
            <h3 id="detail-title">Details</h3>
            <button class="close-btn" onclick="closeDetail()">
                <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                </svg>
            </button>
        </div>
        <div class="detail-panel-content" id="detail-content">
            <!-- Dynamic content -->
        </div>
    </div>

    <script>
        // Step configuration
        const steps = [
            { title: "C1 submits invoice to C2", description: "Seller's system sends UBL invoice to their Access Point" },
            { title: "C2 looks up C3 in SMP", description: "Sender AP discovers receiver AP endpoint via SMP" },
            { title: "C2 processes and sends via AS4", description: "Wraps invoice in SBD, signs, and transmits to C3" },
            { title: "C3 returns AS4 response", description: "Immediate transport acknowledgment (meaning varies by AP)" },
            { title: "C3 sends MLS (optional, 1+ times)", description: "Message Level Status with validation result and reason codes" },
            { title: "C3 delivers to C4", description: "Receiver AP forwards invoice to buyer's ERP system" },
            { title: "C4 processes invoice", description: "Buyer reviews invoice and makes business decision" },
            { title: "C4 sends IMR (optional)", description: "Invoice Message Response: AP (Approved), AB (Pending), RE (Rejected)" }
        ];

        let currentStepIndex = 0;
        const totalSteps = steps.length;

        // Initialize step progress dots
        function initStepProgress() {
            const container = document.getElementById('stepProgress');
            container.innerHTML = '';
            for (let i = 0; i < totalSteps; i++) {
                const dot = document.createElement('div');
                dot.className = 'step-dot';
                dot.onclick = () => goToStep(i);
                container.appendChild(dot);
            }
        }

        // Update UI for current step
        function updateStepUI() {
            document.getElementById('currentStep').textContent = currentStepIndex + 1;
            document.getElementById('totalSteps').textContent = totalSteps;
            document.getElementById('stepTitle').textContent = steps[currentStepIndex].title;

            document.getElementById('prevBtn').disabled = currentStepIndex === 0;
            document.getElementById('nextBtn').disabled = currentStepIndex === totalSteps - 1;

            if (currentStepIndex === totalSteps - 1) {
                document.getElementById('nextBtn').innerHTML = 'Complete <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>';
            } else {
                document.getElementById('nextBtn').innerHTML = 'Next Step <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/></svg>';
            }

            const dots = document.querySelectorAll('.step-dot');
            dots.forEach((dot, i) => {
                dot.className = 'step-dot';
                if (i < currentStepIndex) {
                    dot.classList.add('completed');
                } else if (i === currentStepIndex) {
                    dot.classList.add('active');
                }
            });

            updateVisibleSteps();
        }

        function updateVisibleSteps() {
            const elements = document.querySelectorAll('.step-element');
            elements.forEach(el => {
                const stepNum = parseInt(el.dataset.step);
                if (stepNum <= currentStepIndex + 1) {
                    el.classList.add('visible');
                    if (stepNum === currentStepIndex + 1) {
                        el.classList.add('animate-in');
                    } else {
                        el.classList.remove('animate-in');
                    }
                } else {
                    el.classList.remove('visible', 'animate-in');
                }
            });
        }

        function nextStep() {
            if (currentStepIndex < totalSteps - 1) {
                currentStepIndex++;
                updateStepUI();
            }
        }

        function prevStep() {
            if (currentStepIndex > 0) {
                currentStepIndex--;
                updateStepUI();
            }
        }

        function goToStep(index) {
            if (index >= 0 && index < totalSteps) {
                currentStepIndex = index;
                updateStepUI();
            }
        }

        function resetSteps() {
            currentStepIndex = 0;
            updateStepUI();
        }

        // Detail data
        const details = {
            c1: {
                title: 'C1 - Clear SaaS',
                content: `
                    <div class="detail-section">
                        <h4>Role</h4>
                        <p style="font-size:15px;color:var(--text-secondary);margin-bottom:16px;">
                            Seller's system where invoices are created. This is Clear's SaaS platform.
                        </p>
                    </div>
                    <div class="detail-section">
                        <h4>Responsibilities</h4>
                        <div class="detail-item"><span class="label">Create Invoice</span><span class="value">UBL 2.1 format</span></div>
                        <div class="detail-item"><span class="label">Local Validation</span><span class="value">Recommended</span></div>
                        <div class="detail-item"><span class="label">Submit to AP</span><span class="value">Via REST/SOAP API</span></div>
                    </div>
                    <div class="detail-section">
                        <h4>Connection</h4>
                        <div class="detail-item"><span class="label">Protocol</span><span class="value">REST or SOAP</span></div>
                        <div class="detail-item"><span class="label">Connected To</span><span class="value">C2 (Clear AP)</span></div>
                    </div>
                `
            },
            c2: {
                title: 'C2 - Clear AP',
                content: `
                    <div class="detail-section">
                        <h4>Role</h4>
                        <p style="font-size:15px;color:var(--text-secondary);margin-bottom:16px;">
                            Sender Access Point. Clear's certified Peppol AP that sends invoices to the network.
                        </p>
                    </div>
                    <div class="detail-section">
                        <h4>Processing Steps</h4>
                        <div class="detail-item"><span class="label">1. Receive</span><span class="value">From C1</span></div>
                        <div class="detail-item"><span class="label">2. Validate</span><span class="value">Optional</span></div>
                        <div class="detail-item"><span class="label">3. SMP Lookup</span><span class="value">Find C3</span></div>
                        <div class="detail-item"><span class="label">4. Wrap SBD</span><span class="value">Add envelope</span></div>
                        <div class="detail-item"><span class="label">5. Sign</span><span class="value">XML Signature</span></div>
                        <div class="detail-item"><span class="label">6. Send AS4</span><span class="value">To C3</span></div>
                    </div>
                `
            },
            c3: {
                title: 'C3 - Buyer AP',
                content: `
                    <div class="detail-section">
                        <h4>Role</h4>
                        <p style="font-size:15px;color:var(--text-secondary);margin-bottom:16px;">
                            Receiver Access Point. The buyer's certified Peppol AP that receives invoices.
                        </p>
                    </div>
                    <div class="detail-section">
                        <h4>Processing Steps</h4>
                        <div class="detail-item"><span class="label">1. Receive AS4</span><span class="value">From C2</span></div>
                        <div class="detail-item"><span class="label">2. Verify</span><span class="value">Check signature</span></div>
                        <div class="detail-item"><span class="label">3. Validate</span><span class="value">Varies by AP!</span></div>
                        <div class="detail-item"><span class="label">4. Return AS4</span><span class="value">Immediate</span></div>
                        <div class="detail-item"><span class="label">5. Send MLS</span><span class="value">1+ times</span></div>
                        <div class="detail-item"><span class="label">6. Route to C4</span><span class="value">Deliver</span></div>
                    </div>
                `
            },
            c4: {
                title: 'C4 - Buyer ERP',
                content: `
                    <div class="detail-section">
                        <h4>Role</h4>
                        <p style="font-size:15px;color:var(--text-secondary);margin-bottom:16px;">
                            Buyer's system where invoices are received and processed for payment.
                        </p>
                    </div>
                    <div class="detail-section">
                        <h4>Processing</h4>
                        <div class="detail-item"><span class="label">Receive</span><span class="value">From C3</span></div>
                        <div class="detail-item"><span class="label">Import</span><span class="value">To accounting</span></div>
                        <div class="detail-item"><span class="label">Review</span><span class="value">Business validation</span></div>
                        <div class="detail-item"><span class="label">Respond</span><span class="value">IMR (optional)</span></div>
                    </div>
                `
            },
            msg1: {
                title: 'Message 1: submitInvoice()',
                content: `
                    <div class="detail-section">
                        <h4>Details</h4>
                        <div class="detail-item"><span class="label">From</span><span class="value">C1 (Clear SaaS)</span></div>
                        <div class="detail-item"><span class="label">To</span><span class="value">C2 (Clear AP)</span></div>
                        <div class="detail-item"><span class="label">Protocol</span><span class="value">REST or SOAP API</span></div>
                        <div class="detail-item"><span class="label">Type</span><span class="value">Synchronous</span></div>
                    </div>
                    <div class="detail-section">
                        <h4>Payload</h4>
                        <div class="detail-item"><span class="label">Invoice</span><span class="value">UBL 2.1 XML</span></div>
                        <div class="detail-item"><span class="label">Receiver ID</span><span class="value">e.g., 0208:0403199702</span></div>
                    </div>
                `
            },
            msg2: {
                title: 'Message 2: lookup()',
                content: `
                    <div class="detail-section">
                        <h4>Details</h4>
                        <div class="detail-item"><span class="label">From</span><span class="value">C2 (Clear AP)</span></div>
                        <div class="detail-item"><span class="label">To</span><span class="value">SMP</span></div>
                        <div class="detail-item"><span class="label">Protocol</span><span class="value">REST</span></div>
                        <div class="detail-item"><span class="label">Type</span><span class="value">Synchronous</span></div>
                    </div>
                    <div class="detail-section">
                        <h4>Returns</h4>
                        <div class="detail-item"><span class="label">Endpoint URL</span><span class="value">C3's AS4 endpoint</span></div>
                        <div class="detail-item"><span class="label">Certificate</span><span class="value">C3's public cert</span></div>
                        <div class="detail-item"><span class="label">Capabilities</span><span class="value">Supported docs</span></div>
                    </div>
                `
            },
            msg3: {
                title: 'Message 3: AS4 Transmission',
                content: `
                    <div class="detail-section">
                        <h4>Details</h4>
                        <div class="detail-item"><span class="label">From</span><span class="value">C2 (Clear AP)</span></div>
                        <div class="detail-item"><span class="label">To</span><span class="value">C3 (Buyer AP)</span></div>
                        <div class="detail-item"><span class="label">Protocol</span><span class="value">AS4 / ebMS 3.0</span></div>
                        <div class="detail-item"><span class="label">Transport</span><span class="value">HTTPS</span></div>
                    </div>
                    <div class="detail-section">
                        <h4>Payload Contents</h4>
                        <div class="detail-item"><span class="label">1. SOAP Envelope</span><span class="value">AS4 wrapper</span></div>
                        <div class="detail-item"><span class="label">2. SBD</span><span class="value">Routing headers</span></div>
                        <div class="detail-item"><span class="label">3. Invoice</span><span class="value">UBL 2.1 XML</span></div>
                        <div class="detail-item"><span class="label">4. Signature</span><span class="value">XML-DSig</span></div>
                    </div>
                `
            },
            msg6: {
                title: 'Message 6: deliverInvoice()',
                content: `
                    <div class="detail-section">
                        <h4>Details</h4>
                        <div class="detail-item"><span class="label">From</span><span class="value">C3 (Buyer AP)</span></div>
                        <div class="detail-item"><span class="label">To</span><span class="value">C4 (Buyer ERP)</span></div>
                        <div class="detail-item"><span class="label">Protocol</span><span class="value">Custom (varies)</span></div>
                        <div class="detail-item"><span class="label">Type</span><span class="value">Asynchronous</span></div>
                    </div>
                    <div class="detail-section">
                        <h4>Note</h4>
                        <p style="font-size:14px;color:var(--text-secondary);">
                            The delivery method between C3 and C4 is not standardized by Peppol. Each AP implements their own solution.
                        </p>
                    </div>
                `
            }
        };

        function showDetail(id) {
            const detail = details[id];
            if (!detail) return;

            document.getElementById('detail-title').textContent = detail.title;
            document.getElementById('detail-content').innerHTML = detail.content;
            document.getElementById('detail-panel').classList.add('open');
            document.getElementById('overlay').classList.add('visible');
        }

        function closeDetail() {
            document.getElementById('detail-panel').classList.remove('open');
            document.getElementById('overlay').classList.remove('visible');
        }

        function toggleCard(cardId) {
            document.getElementById(cardId).classList.toggle('expanded');
        }

        // Tooltip
        const tooltip = document.getElementById('tooltip');

        document.querySelectorAll('[data-participant]').forEach(el => {
            el.addEventListener('mouseenter', (e) => {
                const id = el.dataset.participant;
                const detail = details[id];
                if (detail) {
                    tooltip.querySelector('.tooltip-title').textContent = detail.title;
                    tooltip.querySelector('.tooltip-content').textContent = 'Click for details';
                    tooltip.style.left = e.pageX + 12 + 'px';
                    tooltip.style.top = e.pageY + 12 + 'px';
                    tooltip.classList.add('visible');
                }
            });

            el.addEventListener('mouseleave', () => {
                tooltip.classList.remove('visible');
            });

            el.addEventListener('mousemove', (e) => {
                tooltip.style.left = e.pageX + 12 + 'px';
                tooltip.style.top = e.pageY + 12 + 'px';
            });
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeDetail();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                if (!document.getElementById('detail-panel').classList.contains('open')) {
                    nextStep();
                }
            } else if (e.key === 'ArrowLeft') {
                if (!document.getElementById('detail-panel').classList.contains('open')) {
                    prevStep();
                }
            } else if (e.key === 'r' || e.key === 'R') {
                resetSteps();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initStepProgress();
            updateStepUI();
        });
    </script>
</body>
</html>
